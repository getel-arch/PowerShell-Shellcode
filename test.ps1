Set-StrictMode -Version Latest

# -- configuration --
$WorkDir = Join-Path -Path $env:TEMP -ChildPath "benign_chain_test"
New-Item -Path $WorkDir -ItemType Directory -Force | Out-Null

$LoaderName = "mal.exe"
$LoaderPath = Join-Path -Path $WorkDir -ChildPath $LoaderName

$ChromeLoaderName = "chrome.exe"
$ChromeLoaderPath = Join-Path -Path $WorkDir -ChildPath $ChromeLoaderName

# Commandline we want Defender to record for msiexec (matches your KQL)
$MsiexecArgs = 'C:\Users\Test\AppData\Local\Temp\ScreenConnect.ClientSetup.msi /quiet'

# Unique fragment used to identify the msiexec instance to terminate
$MatchFragment = "ScreenConnect.ClientSetup.msi"
Write-Host "[+] Starting anomaly chain"
Write-Host "[+] Working directory: ${WorkDir}"
Write-Host "[+] Mal loader path: ${LoaderPath}"
Write-Host "[+] Chrome loader path: ${ChromeLoaderPath}"
Write-Host "[+] msiexec args: ${MsiexecArgs}"
Write-Host "[+] Using pre-compiled and pre-signed executables"

# -- Base64 encoded executables --
# Encoded Data
$ChromeExeBase64 = "TVqQAAMAAAAEAAAA//8AALgAAAAAAAAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAgAAAAA4fug4AtAnNIbgBTM0hVGhpcyBwcm9ncmFtIGNhbm5vdCBiZSBydW4gaW4gRE9TIG1vZGUuDQ0KJAAAAAAAAABQRQAATAEDAAc38WgAAAAAAAAAAOAAAgELAQsAAAYAAAAIAAAAAAAAPiUAAAAgAAAAQAAAAABAAAAgAAAAAgAABAAAAAAAAAAEAAAAAAAAAACAAAAAAgAAAAAAAAMAQIUAABAAABAAAAAAEAAAEAAAAAAAABAAAAAAAAAAAAAAAPAkAABLAAAAAEAAANgEAAAAAAAAAAAAAAAAAAAAAAAAAGAAAAwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAIAAACAAAAAAAAAAAAAAACCAAAEgAAAAAAAAAAAAAAC50ZXh0AAAARAUAAAAgAAAABgAAAAIAAAAAAAAAAAAAAAAAACAAAGAucnNyYwAAANgEAAAAQAAAAAYAAAAIAAAAAAAAAAAAAAAAAABAAABALnJlbG9jAAAMAAAAAGAAAAACAAAADgAAAAAAAAAAAAAAAAAAQAAAQgAAAAAAAAAAAAAAAAAAAAAgJQAAAAAAAEgAAAACAAUA2CAAABgEAAABAAAAAQAABgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABswAwBhAAAAAQAAEXMDAAAKCgZyAQAAcG8EAAAKBnIRAABwAigFAAAKbwYAAAoGF28HAAAKBhZvCAAACgYoCQAACiYg9AEAACgKAAAKFgzeGgtyFQAAcAdvCwAACigMAAAKKA0AAAoXDN4ACCoAAAABEAAAAAAAAEVFABoJAAABHgIoDgAACipCU0pCAQABAAAAAAAMAAAAdjQuMC4zMDMxOQAAAAAFAGwAAABgAQAAI34AAMwBAACAAQAAI1N0cmluZ3MAAAAATAMAAEQAAAAjVVMAkAMAABAAAAAjR1VJRAAAAKADAAB4AAAAI0Jsb2IAAAAAAAAAAgAAAUcVAgAJAAAAAPolMwAWAAABAAAACQAAAAIAAAACAAAAAQAAAA4AAAACAAAAAQAAAAEAAAACAAAAAAAKAAEAAAAAAAYAOgAzAAYAcQBRAAYAkQBRAAoAyQC2AAYA5wAzAAoAKAG2AAYARwE2AQYAZAEzAAYAdgEzAAAAAAABAAAAAAABAAEAAAAQABUAHQAFAAEAAQBQIAAAAACRAEEACgABANAgAAAAAIYYRgAQAAIAAAABAEwAEQBGABQAGQBGABAAIQBGABAAIQDaABkAKQDuAB4AIQDzABkAIQABASUAIQAUASUAMQAwASoAOQBOATEACQBUATYAKQBdAToAQQBsAUAACQBGABAALgALAE0ALgATAFYARQAEgAAAAAAAAAAAAAAAAAAAAACvAAAABAAAAAAAAAAAAAAAAQAqAAAAAAAEAAAAAAAAAAAAAAABADMAAAAAAAAAADxNb2R1bGU+AGNocm9tZS5leGUAUHJvZ3JhbQBDaHJvbWVMb2FkZXIAbXNjb3JsaWIAU3lzdGVtAE9iamVjdABNYWluAC5jdG9yAGFyZ3YAU3lzdGVtLlJ1bnRpbWUuQ29tcGlsZXJTZXJ2aWNlcwBDb21waWxhdGlvblJlbGF4YXRpb25zQXR0cmlidXRlAFJ1bnRpbWVDb21wYXRpYmlsaXR5QXR0cmlidXRlAGNocm9tZQBTeXN0ZW0uRGlhZ25vc3RpY3MAUHJvY2Vzc1N0YXJ0SW5mbwBzZXRfRmlsZU5hbWUAU3RyaW5nAEpvaW4Ac2V0X0FyZ3VtZW50cwBzZXRfQ3JlYXRlTm9XaW5kb3cAc2V0X1VzZVNoZWxsRXhlY3V0ZQBQcm9jZXNzAFN0YXJ0AFN5c3RlbS5UaHJlYWRpbmcAVGhyZWFkAFNsZWVwAFRvU3RyaW5nAENvbmNhdABDb25zb2xlAFdyaXRlTGluZQBFeGNlcHRpb24AAA9tAGEAbAAuAGUAeABlAAADIAAALUMAaAByAG8AbQBlACAAbABvAGEAZABlAHIAIABmAGEAaQBsAGUAZAA6ACAAAAC89hy7xg3bQruC1gbRMcikAAi3elxWGTTgiQUAAQgdDgMgAAEEIAEBCAQgAQEOBgACDg4dDgQgAQECBgABEhkSEQQAAQEIAyAADgUAAg4ODgQAAQEOBwcDEhESJQgIAQAIAAAAAAAeAQABAFQCFldyYXBOb25FeGNlcHRpb25UaHJvd3MBAAAAGCUAAAAAAAAAAAAALiUAAAAgAAAAAAAAAAAAAAAAAAAAAAAAAAAAACAlAAAAAAAAAABfQ29yRXhlTWFpbgBtc2NvcmVlLmRsbAAAAAAA/yUAIEAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAIAEAAAACAAAIAYAAAAOAAAgAAAAAAAAAAAAAAAAAAAAQABAAAAUAAAgAAAAAAAAAAAAAAAAAAAAQABAAAAaAAAgAAAAAAAAAAAAAAAAAAAAQAAAAAAgAAAAAAAAAAAAAAAAAAAAAAAAQAAAAAAkAAAAKBAAABEAgAAAAAAAAAAAADoQgAA6gEAAAAAAAAAAAAARAI0AAAAVgBTAF8AVgBFAFIAUwBJAE8ATgBfAEkATgBGAE8AAAAAAL0E7/4AAAEAAAAAAAAAAAAAAAAAAAAAAD8AAAAAAAAABAAAAAEAAAAAAAAAAAAAAAAAAABEAAAAAQBWAGEAcgBGAGkAbABlAEkAbgBmAG8AAAAAACQABAAAAFQAcgBhAG4AcwBsAGEAdABpAG8AbgAAAAAAAACwBKQBAAABAFMAdAByAGkAbgBnAEYAaQBsAGUASQBuAGYAbwAAAIABAAABADAAMAAwADAAMAA0AGIAMAAAACwAAgABAEYAaQBsAGUARABlAHMAYwByAGkAcAB0AGkAbwBuAAAAAAAgAAAAMAAIAAEARgBpAGwAZQBWAGUAcgBzAGkAbwBuAAAAAAAwAC4AMAAuADAALgAwAAAAOAALAAEASQBuAHQAZQByAG4AYQBsAE4AYQBtAGUAAABjAGgAcgBvAG0AZQAuAGUAeABlAAAAAAAoAAIAAQBMAGUAZwBhAGwAQwBvAHAAeQByAGkAZwBoAHQAAAAgAAAAQAALAAEATwByAGkAZwBpAG4AYQBsAEYAaQBsAGUAbgBhAG0AZQAAAGMAaAByAG8AbQBlAC4AZQB4AGUAAAAAADQACAABAFAAcgBvAGQAdQBjAHQAVgBlAHIAcwBpAG8AbgAAADAALgAwAC4AMAAuADAAAAA4AAgAAQBBAHMAcwBlAG0AYgBsAHkAIABWAGUAcgBzAGkAbwBuAAAAMAAuADAALgAwAC4AMAAAAAAAAADvu788P3htbCB2ZXJzaW9uPSIxLjAiIGVuY29kaW5nPSJVVEYtOCIgc3RhbmRhbG9uZT0ieWVzIj8+DQo8YXNzZW1ibHkgeG1sbnM9InVybjpzY2hlbWFzLW1pY3Jvc29mdC1jb206YXNtLnYxIiBtYW5pZmVzdFZlcnNpb249IjEuMCI+DQogIDxhc3NlbWJseUlkZW50aXR5IHZlcnNpb249IjEuMC4wLjAiIG5hbWU9Ik15QXBwbGljYXRpb24uYXBwIi8+DQogIDx0cnVzdEluZm8geG1sbnM9InVybjpzY2hlbWFzLW1pY3Jvc29mdC1jb206YXNtLnYyIj4NCiAgICA8c2VjdXJpdHk+DQogICAgICA8cmVxdWVzdGVkUHJpdmlsZWdlcyB4bWxucz0idXJuOnNjaGVtYXMtbWljcm9zb2Z0LWNvbTphc20udjMiPg0KICAgICAgICA8cmVxdWVzdGVkRXhlY3V0aW9uTGV2ZWwgbGV2ZWw9ImFzSW52b2tlciIgdWlBY2Nlc3M9ImZhbHNlIi8+DQogICAgICA8L3JlcXVlc3RlZFByaXZpbGVnZXM+DQogICAgPC9zZWN1cml0eT4NCiAgPC90cnVzdEluZm8+DQo8L2Fzc2VtYmx5Pg0KAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAIAAADAAAAEA1AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA=="
$MalExeBase64 = "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"

# -- Step 1: Extract executables from base64 --
Write-Host "[+] Extracting chrome.exe from base64..."
try {
    $chromeBytes = [System.Convert]::FromBase64String($ChromeExeBase64)
    [System.IO.File]::WriteAllBytes($ChromeLoaderPath, $chromeBytes)
    Write-Host "[+] Successfully extracted chrome.exe to ${ChromeLoaderPath}"
} catch {
    Write-Error "Failed to extract chrome.exe: $($_.Exception.Message)"
    exit 1
}

Write-Host "[+] Extracting mal.exe from base64..."
try {
    $malBytes = [System.Convert]::FromBase64String($MalExeBase64)
    [System.IO.File]::WriteAllBytes($LoaderPath, $malBytes)
    Write-Host "[+] extracted mal.exe to ${LoaderPath}"
} catch {
    Write-Error "[-] Failed to extract mal.exe: $($_.Exception.Message)"
    exit 1
}

# Verify both executables exist
if (-not (Test-Path $ChromeLoaderPath)) {
    Write-Error "[-] chrome.exe not found at ${ChromeLoaderPath}"
    exit 1
}

if (-not (Test-Path $LoaderPath)) {
    Write-Error "[-] mal.exe not found at ${LoaderPath}"
    exit 1
}

Write-Host "[+] Both executables extracted successfully"

# -- Step 2: Launch the chrome.exe loader via Explorer Shell so its parent is explorer.exe --
Write-Host "[+] Launching chrome.exe loader via Explorer shell (parent process will be explorer.exe)..."
$shell = New-Object -ComObject "Shell.Application"
$shell.ShellExecute($ChromeLoaderPath, $MsiexecArgs, $WorkDir, "", 0)

Write-Host "[+] Launched loader. Waiting 15 seconds for telemetry to be generated and collected by Defender/EDR..."
Start-Sleep -Seconds 15

# -- Step 3: Find and terminate msiexec started with our MSI fragment --
try {
    # Query Win32_Process to inspect CommandLine
    $msiProcesses = Get-CimInstance -ClassName Win32_Process -Filter "Name = 'msiexec.exe'" | Where-Object {
        $_.CommandLine -and ($_.CommandLine -like "*$MatchFragment*")
    }

    $count = @($msiProcesses).Count
    Write-Host "[+] Success! msiexec processes matching fragment found: $count"

    if ($count -gt 0) {
        foreach ($p in @($msiProcesses)) {
            Write-Host "[+] Found msiexec PID $($p.ProcessId) with command line: $($p.CommandLine)"
            try {
                # Try graceful terminate via CIM
                $termResult = $p | Invoke-CimMethod -MethodName Terminate
                if ($termResult.ReturnValue -eq 0) {
                    Write-Host "[+] Terminated msiexec PID $($p.ProcessId) via CIM Terminate."
                } else {
                    Write-Output "[!] CIM Terminate returned $($termResult.ReturnValue). Attempting Stop-Process -Force."
                    Stop-Process -Id $p.ProcessId -Force -ErrorAction SilentlyContinue
                }
            } catch {
                Write-Output "[-] Failed to terminate PID $($p.ProcessId) via CIM: $($_.Exception.Message). Attempting Stop-Process -Force."
                Stop-Process -Id $p.ProcessId -Force -ErrorAction SilentlyContinue
            }
        }
    } else {
        Write-Host "[-] No msiexec process with command line fragment '$MatchFragment' was found."
    }
} catch {
    Write-Output "[-] Error while searching for msiexec processes: $($_.Exception.Message)"
}

Write-Host ""
Write-Host "[+] Files present in ${WorkDir}:"
Get-ChildItem -Path $WorkDir | Select-Object Name,Length,LastWriteTime | Format-Table -AutoSize
Start-Sleep -Seconds 80
Write-Host "[+] Script finished"
